# 钉钉机器人消息流程图

## 当前状态（缺少配置）

```
钉钉群用户 → 钉钉服务器 → ❌ 没有配置Webhook → 无法到达您的程序
```

## 完整配置后的流程

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   钉钉群用户     │    │   钉钉服务器     │    │   您的程序       │
│                │    │                │    │                │
│ @机器人 你好    │───▶│ 接收用户消息     │───▶│ /webhook端点    │
│                │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                      │
                                                      ▼
                                              ┌─────────────────┐
                                              │  处理消息内容    │
                                              │  调用AI模型     │
                                              │  生成回复       │
                                              └─────────────────┘
                                                      │
                                                      ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   群里显示回复   │◀───│ 钉钉显示消息     │◀───│ 发送回复到钉钉   │
│                │    │                │    │                │
│ @用户 您好！... │    │                │    │ sessionWebhook  │
│                │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 配置要点

### 1. 双向通信
- **钉钉 → 您的程序**：通过您配置的Webhook URL
- **您的程序 → 钉钉**：通过钉钉提供的sessionWebhook URL

### 2. 关键配置
- **您的程序监听**：`/webhook` 路径
- **钉钉配置**：`https://your-domain.com/webhook`
- **本地开发**：使用ngrok提供公网访问

### 3. 消息格式

**钉钉发送给您的程序：**
```json
{
  "msgtype": "text",
  "text": {
    "content": "@机器人 你好"
  },
  "sessionWebhook": "https://oapi.dingtalk.com/robot/send?access_token=xxxxx",
  "senderStaffId": "user123"
}
```

**您的程序回复给钉钉：**
```json
{
  "msgtype": "text",
  "text": {
    "content": "您好！我是AI助手，有什么可以帮助您的吗？"
  },
  "at": {
    "atUserIds": ["user123"]
  }
}
```

## 立即行动

1. **启动应用**：`python app_simple.py`
2. **暴露公网**：`ngrok http 5000`
3. **配置钉钉**：设置Webhook URL为 `https://xxx.ngrok.io/webhook`
4. **测试功能**：在群里@机器人

现在您就明白为什么需要配置Webhook URL了！这是钉钉向您的程序发送消息的必要步骤。